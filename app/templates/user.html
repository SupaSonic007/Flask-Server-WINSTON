{% extends "base.html" %} {% block meta %}
<meta name="title" content="{{ user.username }}'s Profile" />
<meta name="description" content="The profile page of {{ user.username }}" />
{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %} {% block content %}

<main
    class="px-2 sm:px-5 lg:space-x-10 justify-around space-y-10 lg:space-y-0 flex-row flex-wrap md:h-[calc(100vh-9rem)] hidden"
>
    <div id="userInfo" class="outline w-full lg:w-2/5 flex flex-wrap content-start">
        <img
            id="avatar"
            class="m-5 w-[128px] h-[128px] outline rounded-full mx-auto"
        />

        <div id="userMeta" class="sm:w-1/2 m-5 h-min">
            <p class="text-center sm:text-left underline"><b id="username"></b></p>
            <br />
            <p>Joined <span id="time_created"></span></p>
        </div>
        <p class="w-full m-5">Bio: <span id="bio"></span></p>
    </div>

    <div id="userPosts" class="outline w-full lg:w-1/2 overflow-y-scroll h-full">
        <p class="mt-5 mx-5"><b>Posts</b></p>
        <div id="posts" class="flex flex-wrap lg:w-full"></div>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        
        const avatar = document.getElementById('avatar');
        const username = document.getElementById('username');
        const time_created = document.getElementById('time_created');
        const bio = document.getElementById('bio');

        const user = await getUser('{{ user }}');

        username.innerHTML = user.username;
        time_created.innerHTML = user.time_created;
        bio.innerHTML = user.bio;
        
        avatar.src = user.avatar;

        posts = await user.posts;

        posts.reverse().forEach((post) => {

            a = document.createElement('a');
            a.id = post.id;
            a.href = `{{ url_for('winstogram')}}/${post.id}`;
            a.className =
                'min-w-[calc(100%-2.5rem)] max-w-[calc(100%-2.5rem)] mx-5 my-3 p-2 outline w-full';
            
            header = document.createElement('span');
            header.id = 'header';
            header.className = 'truncate block';
            header.innerHTML = `<b>${post.header}</b>`;
            a.appendChild(header);

            author = document.createElement('span');
            author.id = 'author';
            author.className = 'truncate block';
            author.innerHTML = `<i>by ${post.username} ${moment(post.timestamp).fromNow()}</i>`;
            a.appendChild(author);

            body = document.createElement('span');
            body.id = 'body';
            body.className = 'truncate block';
            body.innerHTML = marked.parse(post.body.replaceAll('\n', ' '), { mangle: false, headerIds: false });
            a.appendChild(body);

            document.getElementById('posts').appendChild(a);

            const main = document.getElementsByTagName('main').item(0);
            main.classList.remove('hidden');
            main.classList.add('flex');
        });
    });

    async function getUser(id) {
        const response = await fetch(`/api/users/${id}`);
        const user = await response.json();
        return user;
    }
</script>

{% endblock %}
