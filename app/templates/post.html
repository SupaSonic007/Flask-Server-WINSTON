{% extends "base.html" %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %} {% block content %}
<div class="w-full">
    <div class="outline rounded bg-accent p-5" id="postContainer"></div>
    <br />
    <div class="outline rounded bg-accent p-5">
        <h2 class="text-2xl">Comments</h2>
        <br />
        {% if current_user.is_active %}
        <form id="commentForm" action="" method="post" autocomplete="off" novalidate>
            {{ form.hidden_tag() }}
            <p>
                {{ form.comment.label }}<br />
                {{ form.comment(rows=5, class_="px-1 border border-black rounded w-full") }} {% for error in
                form.comment.errors %}
                <br />
                <span class="text-black"><b>[{{error}}]</b></span>
                {% endfor %}
            </p>
            <br />
            <p class="text-center md:text-start">
                {{ form.submit(class_="border p-1 border-black rounded bg-accent w-full md:w-auto") }}
            </p>
        </form>
        {% endif %}
        <br />
        <div class="px-1" id="commentsContainer">
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await renderPost();
            const save = document.getElementById('save');
            if ('{{ current_user.is_active }}' !== 'True') {
                return;
            }

            if (await checkExistenceInCollections()) {
                save.classList.add('disabled');
                save.dataset.saved = 'true';
                save.textContent = 'Saved!';
                return;
            } else {
                save.dataset.saved = 'false';
                save.textContent = 'Save';
            }

            if (save.classList.contains('disabled') == false) {
                save.addEventListener('click', async function () {
                    save.dataset.saving = 'true';
                    save.textContent = 'Saving...';
                    const time = new Date().getTime();
                    await fetch("{{ url_for('save_post', id=id) }}", {
                        method: 'POST',
                    });

                    const time2 = new Date().getTime();
                    if (time2 - time < 1000) {
                        await wait(1000 - (time2 - time));
                    }

                    save.classList.add('disabled');
                    save.dataset.saved = 'true';
                    save.textContent = 'Saved!';
                    save.removeEventListener('click', this);
                });
            }
        });

        async function renderPost() {
            const post = await getPost(parseInt('{{ id }}'));
            const body = marked.parse(post.body, {
                mangle: false,
                headerIds: false,
            });

            // DOM manipulation to render post
            const header = document.createElement('div');
            header.id = 'header';

            const headerText = document.createElement('h2');
            headerText.classList.add('text-4xl','truncate');

            const headerTextBold = document.createElement('b');
            headerTextBold.textContent = post.header;

            const author = document.createElement('i');
            author.classList.add('text-2xl');
            author.textContent = 'by ';

            const authorLink = document.createElement('a');
            authorLink.href = `{{ url_for('user', id=authorid) }}`;
            authorLink.classList.add('underline');
            authorLink.textContent = post.username;

            const saveButtonItalics = document.createElement('i');
            saveButtonItalics.classList.add('text-xl', 'opacity-50');
            saveButtonItalics.id = 'saveButton';

            const saveButton = document.createElement('button');
            saveButton.id = 'save';

            const bodyDiv = document.createElement('div');
            bodyDiv.id = 'body';
            bodyDiv.classList.add('px-4','truncate');
            bodyDiv.innerHTML = body;

            saveButtonItalics.appendChild(saveButton);
            author.appendChild(authorLink);
            headerText.appendChild(headerTextBold);
            headerText.appendChild(author);
            headerText.appendChild(document.createElement('br'));
            headerText.appendChild(saveButtonItalics);
            header.appendChild(headerText);

            const postContainer = document.getElementById('postContainer');
            postContainer.appendChild(header);
            postContainer.appendChild(bodyDiv);

            const commentsContainer =
                document.getElementById('commentsContainer');

            if (post.comments != null) {
                for (comment of post.comments) {
                    const commentDiv = document.createElement('div');
                    commentDiv.classList.add(
                        'outline',
                        'rounded',
                        'bg-accent',
                        'p-5',
                        'mb-5'
                        );
                        
                    const commentHeader = document.createElement('div');

                    const commentHeaderNameA = document.createElement('a');
                    commentHeaderNameA.href = `{{ url_for('user', id='') }}${comment.user_id}`;
                    commentHeaderNameA.classList.add('inline');

                    const commentHeaderName = document.createElement('h3');
                    commentHeaderName.classList.add('underline', 'inline');
                    commentHeaderName.textContent = comment.username;

                    commentHeaderNameA.appendChild(commentHeaderName);

                    const commentHeaderTime = document.createElement('i');
                    commentHeaderTime.classList.add(
                        'opacity-50',
                        'inline'
                    );
                    commentHeaderTime.textContent = ` ${moment(
                        comment.timestamp
                    ).fromNow()}`;

                    commentHeader.appendChild(commentHeaderNameA);
                    commentHeader.appendChild(commentHeaderTime);

                    const commentBody = document.createElement('div');
                    commentBody.classList.add('px-4', 'pt-4');
                    commentBody.innerHTML = comment.body;

                    commentDiv.appendChild(commentHeader);
                    commentDiv.appendChild(commentBody);

                    commentsContainer.appendChild(commentDiv);
                }
            }
        }

        async function checkExistenceInCollections() {
            fetched = await fetch(
                '{{ url_for("api_check_existence_in_collections", id=id) }}'
            ).then((res) => res.json());
            return fetched.response;
        }

        async function getPost(id) {
            fetched = await fetch('{{ url_for("api_post", id=id) }}').then(
                (res) => res.json()
            );
            return fetched;
        }

        const wait = (ms) => new Promise((resolve) => setTimeout(resolve, ms));
    </script>

    {% endblock %}
</div>
