{% extends "base.html" %} {% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js" integrity="sha512-LhccdVNGe2QMEfI3x4DVV3ckMRe36TfydKss6mJpdHjNFiV07dFpS2xzeZedptKZrwxfICJpez09iNioiSZ3hA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
{% endblock %} {% block content %}

<content
    class="grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 md:gap-4 md:h-[calc(100vh-9rem)] sm:p-5 hidden"
>
    {% if current_user.is_active %}
    <div class="col-span-1 bg-accent outline p-5 rounded" id="form">
        <form
            id="newPostForm"
            action=""
            method="post"
            autocomplete="off"
            novalidate
        >
            {{ form.hidden_tag() }}
            <p>
                {{ form.subject.label }}<br />
                {{ form.subject(size=40, class_="px-1 border border-black
                rounded w-full") }} {% for error in form.subject.errors %}
                <br />
                <span class="text-black"><b>[{{error}}]</b></span>
                {% endfor %}
            </p>
            <br />
            <p>
                {{ form.body.label }}<br />
                {{ form.body(cols=42, rows=10, class_="px-1 border border-black
                rounded w-full") }} {% for error in form.body.errors %}
                <br />
                <span class="text-black"><b>[{{error}}]</b></span>
                {% endfor %}
            </p>
            <br />
            <p class="text-center md:text-start">
                {{ form.submit(class_="border p-1 border-black rounded bg-accent
                w-full md:w-auto") }}
            </p>
        </form>
    </div>
    {% else %}
    <p class="col-span-full" id="signInRequired">You must be signed in to create a post...</p>
    {% endif %}

    <div
        class="{{ 'col-span-full' if not current_user.is_active else 'sm:col-span-2 md:col-span-2 lg:col-span-3 xl:col-span-4' }} bg-accent overflow-y-auto outline p-5 rounded"
        id="postsContainer"
    ></div>
</content>

<script>
    var posts;
    document.addEventListener('DOMContentLoaded', async () => {
        const container = document.getElementById('postsContainer');

        // Get the latest posts and add them to the page
        posts = await getLatestPosts();

        addPosts(posts, container);

        // Infinite scroll to load new posts when you read the bottom of the page
        container.addEventListener('scroll', async () => {
            if (
                Math.round(container.scrollTop + container.clientHeight) >=
                container.scrollHeight
            ) {
                // Load the previous posts
                var newPosts = await loadPreviousPosts(
                    posts[posts.length - 1].id
                );

                posts.push(...newPosts);

                addPosts(newPosts, container);
            }
        });
        
        // Unhide the content
        content = document.getElementsByTagName('content')[0];
        content.classList.remove('hidden');
        content.classList.add('grid');

        // Add posts until the container is full if the container is not so full that it is scrollable
        while (container.scrollHeight <= container.clientHeight) {
            
            // Load previous posts and add them to the page
            var newPosts = await loadPreviousPosts(posts[posts.length - 1].id);

            // If there are no more posts, stop
            if (newPosts.length == 0) {
                break;
            }

            // Add the new posts to the posts array
            posts.push(...newPosts);

            addPosts(newPosts, container);
        }

        window.addEventListener('scroll', async () => {
            // if the user is at the bottom of the page, load previous posts
            if (
                window.innerHeight + window.scrollY >=
                document.body.offsetHeight
            ) {
                var newPosts = await loadPreviousPosts(
                    posts[posts.length - 1].id
                );

                posts.push(...newPosts);

                addPosts(newPosts, container);
            }
        });

        // After 3 seconds, remove the "You must be signed in"
        await wait(3000);
        // {% if not current_user.is_active %}
        document.getElementById('signInRequired').remove();
        // {% endif %}
    });

    async function getLatestPosts() {
        // Fetch the latest posts
        const response = await fetch("{{ url_for('api_latest_posts') }}");
        const posts = await response.json();
        return posts;
    }

    async function loadPreviousPosts(before) {
        // Load the previous posts
        const response = await fetch(
            `{{ url_for('api_latest_posts') }}?before=${before}`
        );
        const posts = await response.json();
        return posts;
    }

    // add posts to the page fucntion
    function addPosts(posts, container) {
        // Add the posts to the page through DOM manipulation
        if (!posts?.length) {
            return
        }
        for (post of posts) {
            // Create the post item
            a = document.createElement('a');
            a.href = `{{ url_for('winstogram')}}/${post.id}`;

            // Container for the post
            div = document.createElement('div');
            div.className = 'outline bg-accent rounded p-5';
            div.id = post.id;

            // Header container
            header = document.createElement('div');
            header.className = 'truncate';
            header.id = 'header';
            header.innerHTML = `<b>${post.header}</b><br /><i>by ${
                post.username
            } ${moment(moment(post.timestamp).format('YYYY-MM-DD HH:mm:ssZ')).fromNow()}</i>`;
            div.appendChild(header);

            // Body md to html conversion
            const converter = new showdown.Converter()
            body = document.createElement('div');
            body.className = 'px-4 truncate';
            body.id = 'body';
            body.innerHTML = converter.makeHtml(post.body.replaceAll('\n', ' ').replaceAll('![', '! [').replaceAll('#', ''));
            div.appendChild(body);

            // Append everything to create the object
            a.appendChild(div);

            container.appendChild(a);

            br = document.createElement('br');

            container.appendChild(br);
        }
    }

    // Wait function to create timeout after x milliseconds
    const wait = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

</script>

{% endblock %}
